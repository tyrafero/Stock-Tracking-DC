{% load static %}
{% include 'stock/headers.html' %}

<div class="nk-content ">
    <div class="container-fluid">
        <div class="nk-content-inner">
            <div class="nk-content-body">
                <div class="nk-block-head nk-block-head-sm">
                    <div class="nk-block-between">
                        <div class="nk-block-head-content">
                            <div class="nk-block-head-sub">
                                <a class="back-to" href="{% url 'audit_detail' audit.pk %}">
                                    <em class="icon ni ni-arrow-left"></em><span>Back to Audit Details</span>
                                </a>
                            </div>
                            <h3 class="nk-block-title page-title">Approve Audit: {{ audit.audit_reference }}</h3>
                            <div class="nk-block-des text-soft">
                                <p>Review and approve audit results, applying stock adjustments</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warning Alert -->
                <div class="nk-block">
                    <div class="alert alert-pro alert-warning">
                        <div class="alert-text">
                            <h6>Important Notice</h6>
                            <p>Approving this audit will permanently adjust stock quantities based on the physical counts. This action cannot be undone. Please review all variances carefully before proceeding.</p>
                        </div>
                    </div>
                </div>

                <!-- Summary Statistics -->
                <div class="nk-block">
                    <div class="row g-gs">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card bg-light">
                                <div class="nk-ecwg nk-ecwg6">
                                    <div class="card-inner">
                                        <div class="card-title-group">
                                            <div class="card-title">
                                                <h6 class="title">Total Items</h6>
                                            </div>
                                        </div>
                                        <div class="data">
                                            <div class="data-group">
                                                <div class="amount">{{ audit.total_items_planned }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card bg-light">
                                <div class="nk-ecwg nk-ecwg6">
                                    <div class="card-inner">
                                        <div class="card-title-group">
                                            <div class="card-title">
                                                <h6 class="title">Items Counted</h6>
                                            </div>
                                        </div>
                                        <div class="data">
                                            <div class="data-group">
                                                <div class="amount">{{ audit.total_items_counted }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card {% if audit.items_with_variances > 0 %}bg-danger-dim{% else %}bg-success-dim{% endif %}">
                                <div class="nk-ecwg nk-ecwg6">
                                    <div class="card-inner">
                                        <div class="card-title-group">
                                            <div class="card-title">
                                                <h6 class="title">Items with Variances</h6>
                                            </div>
                                        </div>
                                        <div class="data">
                                            <div class="data-group">
                                                <div class="amount">{{ audit.items_with_variances }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card bg-primary-dim">
                                <div class="nk-ecwg nk-ecwg6">
                                    <div class="card-inner">
                                        <div class="card-title-group">
                                            <div class="card-title">
                                                <h6 class="title">Completion</h6>
                                            </div>
                                        </div>
                                        <div class="data">
                                            <div class="data-group">
                                                <div class="amount">{{ audit.completion_percentage }}%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Variance Items -->
                {% if variance_items %}
                <div class="nk-block">
                    <div class="card">
                        <div class="card-inner">
                            <div class="card-head">
                                <h5 class="card-title">Items with Variances</h5>
                                <p class="card-text">The following items will have their stock quantities adjusted:</p>
                            </div>
                            <div class="nk-tb-list nk-tb-ulist">
                                <div class="nk-tb-item nk-tb-head">
                                    <div class="nk-tb-col"><span class="sub-text">Item</span></div>
                                    <div class="nk-tb-col tb-col-md"><span class="sub-text">Current System Qty</span></div>
                                    <div class="nk-tb-col tb-col-md"><span class="sub-text">Physical Count</span></div>
                                    <div class="nk-tb-col tb-col-md"><span class="sub-text">Variance</span></div>
                                    <div class="nk-tb-col tb-col-md"><span class="sub-text">New System Qty</span></div>
                                    <div class="nk-tb-col tb-col-md"><span class="sub-text">Reason</span></div>
                                </div>
                                {% for item in variance_items %}
                                <div class="nk-tb-item">
                                    <div class="nk-tb-col">
                                        <div class="user-card">
                                            <div class="user-info">
                                                <span class="tb-lead">{{ item.stock.item_name }}</span>
                                                <span class="tb-sub">{{ item.stock.category.group|default:"No Category" }}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="nk-tb-col tb-col-md">
                                        <span class="tb-amount">{{ item.system_quantity }}</span>
                                    </div>
                                    <div class="nk-tb-col tb-col-md">
                                        <span class="tb-amount">{{ item.physical_count }}</span>
                                    </div>
                                    <div class="nk-tb-col tb-col-md">
                                        <span class="tb-amount {% if item.variance_quantity > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {% if item.variance_quantity > 0 %}+{% endif %}{{ item.variance_quantity }}
                                        </span>
                                    </div>
                                    <div class="nk-tb-col tb-col-md">
                                        <span class="tb-amount fw-bold {% if item.variance_quantity > 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ item.physical_count }}
                                        </span>
                                    </div>
                                    <div class="nk-tb-col tb-col-md">
                                        <span class="tb-status">{{ item.get_variance_reason_display|default:"Not specified" }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="nk-block">
                    <div class="card">
                        <div class="card-inner text-center py-4">
                            <div class="user-avatar lg bg-success-dim">
                                <em class="icon ni ni-check-circle text-success"></em>
                            </div>
                            <h5 class="mt-3 text-success">No Variances Detected</h5>
                            <p class="text-soft">All physical counts match the system quantities. No stock adjustments are needed.</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Confirmation Form -->
                <div class="nk-block">
                    <div class="card">
                        <div class="card-inner">
                            <form method="post" class="form-validate">
                                {% csrf_token %}
                                <div class="row g-4">
                                    <div class="col-12">
                                        <div class="custom-control custom-checkbox">
                                            <input type="checkbox" class="custom-control-input" id="confirm-approval" required>
                                            <label class="custom-control-label" for="confirm-approval">
                                                I confirm that I have reviewed all variances and authorize the application of stock adjustments.
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group">
                                            <button type="submit" class="btn btn-primary btn-lg">
                                                <em class="icon ni ni-check-thick"></em><span>Approve Audit & Apply Adjustments</span>
                                            </button>
                                            <a href="{% url 'audit_detail' audit.pk %}" class="btn btn-outline-light btn-lg">Cancel</a>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

{% include 'stock/footers.html' %}