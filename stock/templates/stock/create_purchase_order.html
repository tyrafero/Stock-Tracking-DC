{% load static %}
{% load crispy_forms_tags %}
{% include 'stock/headers.html' %}

<style>
/* Formset row */
.formset-row { border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem; margin-bottom: 0.5rem; display: flex; align-items: center; min-width: 900px; }
.formset-row.to-delete { opacity: 0.5; background-color: #f8d7da; }
.formset-row input, .formset-row select { width: 100%; }

/* Horizontal scroll wrapper */
.table-responsive { overflow-x: auto; padding-bottom: 1rem; }

/* Table headers */
.items-table-header { display: flex; font-weight: 600; padding: 0.5rem; min-width: 900px; border-bottom: 1px solid #dee2e6; }
.items-table-header div { text-align: left; padding: 0 0.25rem; }

/* Column widths */
.col-product { width: 200px; flex-shrink: 0; }
.col-order { width: 120px; flex-shrink: 0; }
.col-price { width: 100px; flex-shrink: 0; }
.col-price-exc { width: 100px; flex-shrink: 0; }
.col-quantity { width: 80px; flex-shrink: 0; }
.col-discount { width: 100px; flex-shrink: 0; }
.col-received { width: 100px; flex-shrink: 0; }
.col-subtotal { width: 120px; flex-shrink: 0; }
.col-action { width: 80px; flex-shrink: 0; }

/* Purchase totals section */
.po-totals {  padding: 1.5rem; border-radius: 0.5rem; margin-top: 2rem; border: 1px solid #dee2e6; }

/* Autocomplete styling */
.col-product { position: relative; }
.autocomplete-suggestions { border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
.suggestion-item:hover, .suggestion-item.active { background-color: #f8f9fa; }
.suggestion-item.existing-stock:hover, .suggestion-item.existing-stock.active { background-color: #d4edda; }
.suggestion-item:last-child { border-bottom: none; }
</style>

<div class="nk-content">
  <div class="container-fluid">
    <div class="nk-content-inner">
      <div class="nk-content-body">
        <div class="components-preview wide-lg mx-auto">
          <div class="nk-block nk-block-lg">

            <h4 class="nk-block-title">{{ title }}</h4>
            <p>{% if purchase_order %}Edit{% else %}Create{% endif %} a purchase order for your suppliers.</p>

            <form method="post" id="purchase-order-form">
              {% csrf_token %}

              <!-- Purchase Order Form -->
              <div class="card mb-4">
                <div class="card-inner">
                  {{ po_form|crispy }}
                  <div id="manufacturer-details"></div>
                </div>
              </div>

              <!-- Product Items Section -->
              <div class="card mb-4">
                <div class="card-inner">
                  <h5 class="mb-4">Product Items</h5>

                  <div class="table-responsive">
                    <div class="items-table-header">
                      <div class="col-product">Product</div>
                      <div class="col-order">Order #</div>
                      <div class="col-price">Price Inc</div>
                      <div class="col-price-exc">Price Exc</div>
                      <div class="col-quantity">Quantity</div>
                      <div class="col-discount">Discount %</div>
                      <div class="col-received">Received Qty</div>
                      <div class="col-subtotal">Subtotal Exc</div>
                      <div class="col-action">Action</div>
                    </div>

                    <div id="item-formset">
                      {{ item_formset.management_form }}
                      {% for form in item_formset %}
                      <div class="formset-row">
                        {{ form.id }}
                        <div class="col-product">
                          {{ form.product }}
                          <div class="autocomplete-suggestions" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 200px;"></div>
                        </div>
                        <div class="col-order">{{ form.associated_order_number }}</div>
                        <div class="col-price">{{ form.price_inc }}</div>
                        <div class="col-price-exc"><input type="text" class="form-control calculated-field price-exc-display" readonly></div>
                        <div class="col-quantity">{{ form.quantity }}</div>
                        <div class="col-discount">{{ form.discount_percent }}</div>
                        <div class="col-received">{{ form.received_quantity }}</div>
                        <div class="col-subtotal"><input type="text" class="form-control calculated-field subtotal-display" readonly></div>
                        <div class="col-action">
                          <select class="form-control item-action">
                            <option value="">Select</option>
                            <option value="delete">Delete</option>
                          </select>
                        </div>
                        {% if form.DELETE %}{{ form.DELETE }}{% endif %}
                      </div>
                      {% endfor %}
                    </div>
                  </div>

                  <button type="button" class="btn btn-outline-primary add-item-btn mt-3" id="add-item">
                    <i class="icon ni ni-plus"></i> Add Item
                  </button>
                </div>
              </div>

              <!-- Purchase Order Totals -->
              <div class="card mb-4">
                <div class="card-inner">
                  <div class="po-totals">
                    <h5 class="mb-3">Purchase Order Totals</h5>
                    <div class="row">
                      <div class="col-md-6">
                        <div class="d-flex justify-content-between mb-2"><span>Subtotal (Exc GST):</span><span id="subtotal-exc">$0.00</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>Total Discount:</span><span id="total-discount">$0.00</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>After Discount:</span><span id="after-discount">$0.00</span></div>
                        <div class="d-flex justify-content-between mb-2"><span>GST (10%):</span><span id="gst-amount">$0.00</span></div>
                        <hr>
                        <div class="d-flex justify-content-between"><strong>GRAND TOTAL:</strong><strong id="grand-total">$0.00</strong></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Submit Buttons -->
              <div class="card">
                <div class="card-inner">
                  <div class="d-flex justify-content-between">
                    <a href="{% url 'purchase_order_list' %}" class="btn btn-outline-gray"><i class="icon ni ni-arrow-left"></i> Back to List</a>
                    <div>
                      <button type="submit" name="action" value="save_draft" class="btn btn-outline-primary me-2"><i class="icon ni ni-file-docs"></i> Save as Draft</button>
                      <button type="submit" name="action" value="submit" class="btn btn-primary"><i class="icon ni ni-check"></i> Submit Purchase Order</button>
                    </div>
                  </div>
                </div>
              </div>

            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'stock/footers.html' %}

<script>
$(document).ready(function() {
    function calculateTotals() {
        let subtotal = 0;
        let totalDiscount = 0;

        $('#item-formset .formset-row').each(function() {
            const price = parseFloat($(this).find('input[name$="-price_inc"]').val()) || 0;
            const quantity = parseFloat($(this).find('input[name$="-quantity"]').val()) || 0;
            const discountPercent = parseFloat($(this).find('input[name$="-discount_percent"]').val()) || 0;

            const priceExc = price * 0.9; // 10% GST included
            const lineTotalExc = priceExc * quantity;
            const discountAmount = (lineTotalExc * discountPercent) / 100;
            const subtotalExc = lineTotalExc - discountAmount;

            $(this).find('.price-exc-display').val(priceExc.toFixed(2));
            $(this).find('.subtotal-display').val(subtotalExc.toFixed(2));

            subtotal += lineTotalExc;
            totalDiscount += discountAmount;
        });

        const afterDiscount = subtotal - totalDiscount;
        const gst = afterDiscount * 0.10;
        const grandTotal = afterDiscount + gst;

        $('#subtotal-exc').text(`$${subtotal.toFixed(2)}`);
        $('#total-discount').text(`$${totalDiscount.toFixed(2)}`);
        $('#after-discount').text(`$${afterDiscount.toFixed(2)}`);
        $('#gst-amount').text(`$${gst.toFixed(2)}`);
        $('#grand-total').text(`$${grandTotal.toFixed(2)}`);
    }

    // Initial calculation on page load
    calculateTotals();

    // Recalculate on input changes
    $('#item-formset').on('input', 'input[name$="-price_inc"], input[name$="-quantity"], input[name$="-discount_percent"]', function() {
        calculateTotals();
    });

    // Add new item
    var itemCount = parseInt($('#id_items-TOTAL_FORMS').val()) || 0;
    $('#add-item').click(function() {
        var newItem = `
        <div class="formset-row">
            <div class="col-product">
                <input type="text" name="items-${itemCount}-product" class="form-control product-input" placeholder="Product" required>
                <div class="autocomplete-suggestions" style="display: none; position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; width: 200px;"></div>
            </div>
            <div class="col-order"><input type="text" name="items-${itemCount}-associated_order_number" class="form-control" placeholder="Order #"></div>
            <div class="col-price"><input type="number" name="items-${itemCount}-price_inc" class="form-control" step="0.01" min="0" required></div>
            <div class="col-price-exc"><input type="text" class="form-control calculated-field price-exc-display" readonly></div>
            <div class="col-quantity"><input type="number" name="items-${itemCount}-quantity" class="form-control" min="1" required></div>
            <div class="col-discount"><input type="number" name="items-${itemCount}-discount_percent" class="form-control" min="0" max="100" step="0.01"></div>
            <div class="col-received"><input type="number" name="items-${itemCount}-received_quantity" class="form-control" min="0"></div>
            <div class="col-subtotal"><input type="text" class="form-control calculated-field subtotal-display" readonly></div>
            <div class="col-action">
                <select class="form-control item-action">
                    <option value="">Select</option>
                    <option value="delete">Delete</option>
                </select>
            </div>
        </div>
        `;
        $('#item-formset').append(newItem);
        itemCount++;
        $('#id_items-TOTAL_FORMS').val(itemCount);
        calculateTotals();
    });

    // Delete item row
    $('#item-formset').on('change', '.item-action', function() {
        if ($(this).val() === 'delete') {
            $(this).closest('.formset-row').remove();
            calculateTotals();
        }
    });

    // Stock item autocomplete functionality
    function setupAutocomplete(inputElement) {
        const $input = $(inputElement);
        const $suggestions = $input.siblings('.autocomplete-suggestions');
        let currentTimeout;

        $input.on('input', function() {
            const query = $(this).val().trim();
            
            // Clear previous timeout
            if (currentTimeout) {
                clearTimeout(currentTimeout);
            }

            if (query.length < 2) {
                $suggestions.hide();
                return;
            }

            // Debounce the search to avoid too many requests
            currentTimeout = setTimeout(function() {
                $.ajax({
                    url: '{% url "stock_item_suggestions" %}',
                    data: { 'q': query },
                    dataType: 'json',
                    success: function(data) {
                        displaySuggestions($suggestions, data.suggestions, $input);
                    },
                    error: function() {
                        console.log('Error fetching suggestions');
                    }
                });
            }, 300);
        });

        // Hide suggestions when clicking outside
        $(document).on('click', function(e) {
            if (!$input.is(e.target) && !$suggestions.is(e.target) && $suggestions.has(e.target).length === 0) {
                $suggestions.hide();
            }
        });

        // Handle keyboard navigation
        $input.on('keydown', function(e) {
            const $activeItem = $suggestions.find('.suggestion-item.active');
            
            if (e.keyCode === 40) { // Down arrow
                e.preventDefault();
                if ($activeItem.length === 0) {
                    $suggestions.find('.suggestion-item').first().addClass('active');
                } else {
                    $activeItem.removeClass('active').next('.suggestion-item').addClass('active');
                }
            } else if (e.keyCode === 38) { // Up arrow
                e.preventDefault();
                if ($activeItem.length === 0) {
                    $suggestions.find('.suggestion-item').last().addClass('active');
                } else {
                    $activeItem.removeClass('active').prev('.suggestion-item').addClass('active');
                }
            } else if (e.keyCode === 13) { // Enter key
                e.preventDefault();
                if ($activeItem.length > 0) {
                    $activeItem.click();
                }
            } else if (e.keyCode === 27) { // Escape key
                $suggestions.hide();
            }
        });
    }

    function displaySuggestions($container, suggestions, $input) {
        $container.empty();
        
        if (suggestions.length === 0) {
            $container.hide();
            return;
        }

        suggestions.forEach(function(suggestion) {
            const $item = $('<div class="suggestion-item" style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;"></div>');
            
            if (suggestion.type === 'existing_stock') {
                $item.html(`
                    <div style="font-weight: 500; color: #28a745;">${suggestion.name}</div>
                    <small style="color: #6c757d;">In Stock: ${suggestion.quantity} ${suggestion.unit} | ${suggestion.store}</small>
                `);
                $item.addClass('existing-stock');
            } else {
                $item.html(`
                    <div style="font-weight: 500; color: #6c757d;">${suggestion.name}</div>
                    <small style="color: #6c757d;">Previously ordered item</small>
                `);
                $item.addClass('previous-order');
            }
            
            $item.on('click', function() {
                $input.val(suggestion.name);
                $container.hide();
                $input.focus();
            });

            $item.on('mouseenter', function() {
                $container.find('.suggestion-item').removeClass('active');
                $(this).addClass('active');
            });

            $container.append($item);
        });

        $container.show();
    }

    // Setup autocomplete for existing product inputs
    $('.product-input').each(function() {
        setupAutocomplete(this);
    });

    // Setup autocomplete for dynamically added product inputs
    $('#item-formset').on('focus', '.product-input', function() {
        if (!$(this).data('autocomplete-setup')) {
            setupAutocomplete(this);
            $(this).data('autocomplete-setup', true);
        }
    });
});
</script>
