{% load static %}
{% load crispy_forms_tags %}

{% include 'stock/headers.html' %}

<style>
/* ðŸŽ¨ Custom Bootstrap tooltip styling */
.tooltip-inner {
    background-color: #1e293b !important;   /* dark slate bg */
    color: #f8fafc !important;              /* soft white text */
    font-size: 14px;
    font-weight: 500;
    padding: 8px 12px;
    border-radius: 8px;
    box-shadow: 0px 4px 12px rgba(0,0,0,0.25);
    max-width: 220px; /* prevent extra wide tooltips */
    text-align: center;
}
.tooltip.bs-tooltip-top .arrow::before {
    border-top-color: #1e293b !important;
}
.tooltip.bs-tooltip-bottom .arrow::before {
    border-bottom-color: #1e293b !important;
}
.tooltip.bs-tooltip-left .arrow::before {
    border-left-color: #1e293b !important;
}
.tooltip.bs-tooltip-right .arrow::before {
    border-right-color: #1e293b !important;
}

/* Fix table overflow issues */
.datatable-init {
    table-layout: fixed !important;
    width: 100% !important;
    overflow-x: auto !important;
}

.nk-tb-list {
    table-layout: fixed !important;
    width: 100% !important;
}

.nk-tb-col {
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    padding: 8px 12px !important;
}

/* Specific styling for notes column */
.notes-column {
    width: 200px !important;
    min-width: 200px !important;
    max-width: 200px !important;
    overflow: hidden !important;
    position: relative !important;
}

.notes-text {
    word-wrap: break-word !important;
    word-break: break-word !important;
    white-space: normal !important;
    overflow-wrap: break-word !important;
    hyphens: auto !important;
    max-width: 180px !important;
    line-height: 1.3 !important;
    font-size: 12px !important;
    overflow: hidden !important;
    display: block !important;
}

/* ðŸ”¥ Simple text color coding for stock operations */
.row-issue {
    /* No background - just for targeting */
}

.row-receive {
    /* No background - just for targeting */
}

/* Make all text in issue rows red */
.row-issue td .tb-sub,
.row-issue td .tb-lead,
.row-issue .nk-tb-col span {
    color: #f87171 !important; /* Light red text for dark mode */
}

/* Make all text in receive rows green */
.row-receive td .tb-sub,
.row-receive td .tb-lead,
.row-receive .nk-tb-col span {
    color: #4ade80 !important; /* Light green text for dark mode */
}

/* Remove quantity highlighting - keep it simple */
</style>

<div class="nk-content ">
    <div class="container-fluid">
        <div class="nk-content-inner">
            <div class="nk-content-body">
                <div class="components-preview wide-md mx-auto">
                     <div class="nk-block nk-block-lg">
                        <div class="nk-block-head">
                            <div class="nk-block-head-content">
                                <h4 class="nk-block-title">{{title}}</h4>
                            </div>
                        </div>

                        <!-- Filter Form -->
                        <div class="card card-bordered mb-4">
                            <div class="card-inner">
                                <h5 class="card-title">Filter History</h5>
                                <form method="POST" action="">
                                    {% csrf_token %}
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label">Category</label>
                                            {{ form.category }}
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Item Name</label>
                                            {{ form.item_name }}
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">Start Date</label>
                                            {{ form.start_date }}
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">End Date</label>
                                            {{ form.end_date }}
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <div class="d-flex flex-column gap-2">
                                                <button type="submit" class="btn btn-primary btn-block">
                                                    <em class="icon ni ni-search"></em> Filter
                                                </button>
                                                <a href="{% url 'view_history' %}" class="btn btn-outline-secondary btn-block">
                                                    <em class="icon ni ni-reload"></em> Reset
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-md-6">
                                            <div class="custom-control custom-checkbox">
                                                {{ form.export_to_CSV }}
                                                <label class="custom-control-label" for="{{ form.export_to_CSV.id_for_label }}">
                                                    Export filtered results to CSV
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                    <!-- Results Summary -->
                    <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                        <span>
                            <strong>{{ history|length }}</strong> record{{ history|length|pluralize }} found
                            {% if request.method == 'POST' %}(filtered results){% endif %}
                        </span>
                        <small class="text-muted">
                            Latest records shown first â€¢ Times in Sydney timezone
                        </small>
                    </div>

                    <div class="table-responsive" style="overflow-x: auto;">
                        <table class="datatable-init nowrap nk-tb-list is-separate" data-auto-responsive="false" style="min-width: 1000px;">
                            <thead>
                                <tr class="nk-tb-item nk-tb-head">
                                    <th class="nk-tb-col"><span>CATEGORY</span></th>
                                    <th class="nk-tb-col tb-col-md"><span>ITEM NAME</span></th>
                                    <th class="nk-tb-col tb-col-md"><span>QUANTITY IN STORE</span></th>
                                    <th class="nk-tb-col tb-col-md"><span>ISSUE QUANTITY</span></th>
                                    <th class="nk-tb-col tb-col-md"><span>RECEIVE QUANTITY</span></th>
                                    <th class="nk-tb-col tb-col-md"><span>ISSUED BY / RECEIVED BY</span></th>
                                    <th class="nk-tb-col tb-col-lg notes-column"><span>NOTES</span></th>
                                    <th class="nk-tb-col tb-col-md"><span>DATE & TIME</span></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for total in history %}
                                <tr class="nk-tb-item
                                    {% if total.issue_quantity > 0 %}row-issue
                                    {% elif total.receive_quantity > 0 %}row-receive
                                    {% endif %}">
                                    <td class="nk-tb-col">
                                        <span class="tb-lead">{{ total.category }}</span>
                                    </td>
                                    <td class="nk-tb-col">
                                        <span class="tb-sub" data-toggle="tooltip" data-placement="top"
                                              title="{% if total.issue_quantity > 0 %}Issued To: {{ total.note|default:'No note provided' }}{% elif total.receive_quantity > 0 %}Received From: {{ total.note|default:'No note provided' }}{% else %}Note: {{ total.note|default:'No note' }}{% endif %}">
                                            {{ total.item_name }}
                                        </span>
                                    </td>
                                    <td class="nk-tb-col tb-col-md">
                                        <span class="tb-sub">{{ total.quantity }}</span>
                                    </td>
                                    <td class="nk-tb-col tb-col-md">
                                        <span class="tb-sub">
                                            {{ total.issue_quantity }}
                                        </span>
                                    </td>
                                    <td class="nk-tb-col tb-col-md">
                                        <span class="tb-sub">
                                            {{ total.receive_quantity }}
                                        </span>
                                    </td>
                                    <td class="nk-tb-col tb-col-md">
                                        <span class="tb-sub">
                                            {% if total.issue_quantity > 0 %}{{ total.issued_by }}{% elif total.receive_quantity > 0 %}{{ total.received_by }}{% else %}{{ total.created_by }}{% endif %}
                                        </span>
                                    </td>
                                    <td class="nk-tb-col tb-col-lg notes-column">
                                        <div class="tb-sub notes-text">
                                            {{ total.note|default:"No notes"|truncatechars:150 }}
                                        </div>
                                    </td>
                                    <td class="nk-tb-col tb-col-md">
                                        <span class="tb-sub">
                                            {% if total.timestamp %}
                                                {{ total.timestamp|date:"M d, Y H:i" }}
                                            {% elif total.last_updated %}
                                                {{ total.last_updated|date:"M d, Y H:i" }}
                                            {% else %}
                                                No date
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div> <!-- table-responsive -->
                    </div> <!-- nk-block -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="nk-content ">
    <div class="container-fluid">
        <div class="nk-content-inner">
            <div class="nk-content-body">
            </div>
        </div>
    </div>
</div>

{% include 'stock/footers.html' %}

<script src="{% static 'js/sweetalert2.all.min.js' %}"></script>
{% for message in messages %}
    <script>
        Swal.fire({
          position: 'center',
          icon: 'success',
          title: '{{message}}',
          showConfirmButton: true,
          timer: 15000
        })
    </script>
{% endfor %}

{% for every in everything %}
<script>
    document.getElementById('{{forloop.counter}}').onclick = function(){
        const swalWithBootstrapButtons = Swal.mixin({
          customClass: {
            confirmButton: 'btn btn-success',
            cancelButton: 'btn btn-danger'
          },
          buttonsStyling: false
        })

        swalWithBootstrapButtons.fire({
          title: 'Are you sure you want to delete {{every.item_name}}?',
          text: "You won't be able to revert this!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: '<a href="{% url 'delete_stock' every.id %}">Delete</a>',
          cancelButton: 'Cancel',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            swalWithBootstrapButtons.fire(
              'Deleted!',
              '{{every.item_name}} has been deleted.',
              'success'
            )
          } else if (result.dismiss === Swal.DismissReason.cancel) {
            swalWithBootstrapButtons.fire(
              'Cancelled',
              'Your item is safe :)',
              'error'
            )
          }
        })
    };
</script>
{% endfor %}

<!-- âœ… Initialize Bootstrap tooltips -->
<script>
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })
</script>

<!-- âœ… Override DataTable default sorting to sort by Date column (index 7) descending -->
<script>
$(document).ready(function() {
    // Wait for DataTable to initialize, then override the sorting
    setTimeout(function() {
        var table = $('.datatable-init').DataTable();
        // Sort by Date column (index 7) in descending order (latest first)
        table.order([7, 'desc']).draw();
    }, 100);
});
</script>